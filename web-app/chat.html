<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Automatic Chess Board Control</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: linear-gradient(135deg, #6a82fb 0%, #fc5c7d 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .main-container {
      width: 100%;
      max-width: 600px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 24px;
      display: flex;
      flex-direction: column;
    }
    h2 {
      color: #333;
      text-align: center;
      margin-top: 0;
      margin-bottom: 24px;
      font-weight: 600;
    }
    .room-controls, .board-selector-container {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .room-controls input, .board-selector-container select { flex-grow: 1; }
    #gameInfo {
      text-align: center;
      margin: 0 0 16px 0;
      padding: 10px;
      background-color: #f7f7f9;
      border-radius: 8px;
    }
    #moveHistory {
      border: 1px solid #e0e0e0;
      height: 250px;
      overflow-y: auto;
      padding: 16px;
      margin-bottom: 16px;
      background: #f9f9f9;
      border-radius: 12px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    input, select, button { padding: 12px 14px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; font-family: 'Poppins', sans-serif; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, select:focus { border-color: #fc5c7d; box-shadow: 0 0 0 3px rgba(252, 92, 125, 0.15); outline: none; }
    .move-controls { display: flex; flex-direction: column; gap: 10px; }
    button { background: linear-gradient(90deg, #fc5c7d 0%, #6a82fb 100%); color: #fff; border: none; font-weight: 500; cursor: pointer; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="main-container">
    <h2>Automatic Chess Board Control</h2>

    <!-- Board Selection -->
    <div id="boardSelectorContainer" class="board-selector-container hidden">
      <label for="boardSelector" style="white-space: nowrap; align-self: center;">Your Board:</label>
      <select id="boardSelector"></select>
    </div>

    <!-- Room Controls -->
    <div class="room-controls">
      <button id="createGameBtn">Create Game</button>
      <input type="text" id="joinCode" placeholder="Enter Game Code to Join" />
      <button id="joinGameBtn">Join Game</button>
    </div>

    <div id="gameInfo">Enter a game code or create a new game.</div>

    <!-- Move History -->
    <div id="moveHistory"></div>
    
    <!-- Move Input -->
    <div class="move-controls">
      <input type="text" id="moveInput" placeholder="Enter move (e.g., e2e4)" />
      <button id="makeMoveBtn">Make Move</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue, off } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    // --- Firebase Configuration ---
  const firebaseConfig = {
  apiKey: "AIzaSyCBvefflN0iL7_6B9xZMF8v8fm-Z4wSMW8",
  authDomain: "pipico-4977f.firebaseapp.com",
  databaseURL: "https://pipico-4977f-default-rtdb.firebaseio.com",
  projectId: "pipico-4977f",
  storageBucket: "pipico-4977f.firebasestorage.app",
  messagingSenderId: "1017200026188",
  appId: "1:1017200026188:web:2c1956d8adec06622c0ae9"
};
    // --- Initialize ---
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    // --- UI Elements ---
    const createGameBtn = document.getElementById('createGameBtn');
    const joinGameBtn = document.getElementById('joinGameBtn');
    const makeMoveBtn = document.getElementById('makeMoveBtn');
    const gameInfo = document.getElementById('gameInfo');
    const moveHistory = document.getElementById('moveHistory');
    const moveInput = document.getElementById('moveInput');
    const boardSelector = document.getElementById('boardSelector');
    const boardSelectorContainer = document.getElementById('boardSelectorContainer');

    // --- Global State ---
    let currentUser = null;
    let currentGameCode = null;
    let gameListener = null;

    // --- Authentication & Board Fetching ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        fetchUserBoards(user.uid);
      } else {
        alert("You are not logged in. Please log in.");
        // window.location.href = "login.html";
      }
    });

    async function fetchUserBoards(uid) {
        const userBoardsRef = ref(database, `users/${uid}/boards`);
        const snapshot = await get(userBoardsRef);
        if (snapshot.exists()) {
            boardSelector.innerHTML = ''; // Clear previous options
            const boardIds = Object.keys(snapshot.val());
            boardIds.forEach(boardId => {
                const option = document.createElement('option');
                option.value = boardId;
                option.textContent = boardId; // e.g., "board-A1B2C3D4E5F6"
                boardSelector.appendChild(option);
            });
            boardSelectorContainer.classList.remove('hidden');
        } else {
            gameInfo.textContent = "No chess boards registered to your account.";
            createGameBtn.disabled = true;
            joinGameBtn.disabled = true;
        }
    }

    // --- Event Listeners ---
    createGameBtn.addEventListener('click', createGame);
    joinGameBtn.addEventListener('click', joinGame);
    makeMoveBtn.addEventListener('click', makeMove);
    moveInput.addEventListener('keypress', (e) => e.key === 'Enter' && makeMove());

    // --- Core Game Functions ---
    function generateRoomCode() {
      const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789';
      return Array.from({ length: 6 }, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
    }
    
    async function createGame() {
        if (!currentUser || boardSelector.value === '') {
            alert("Please select a board first.");
            return;
        }
        const roomCode = generateRoomCode();
        const selectedBoardId = boardSelector.value;
        const gameRef = ref(database, `games/${roomCode}`);
        const boardRef = ref(database, `boards/${selectedBoardId}/currentGame`);

        const newGame = {
            status: "waiting",
            playerWhite: currentUser.uid,
            boardWhite: selectedBoardId,
            playerBlack: null,
            boardBlack: null,
            fen: "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1", // Initial FEN
            lastMove: { from: "", to: "" },
            moves: [],
            createdAt: new Date().toISOString()
        };

        await set(gameRef, newGame);
        await set(boardRef, roomCode); // Assign game to board

        console.log(`Game created with code: ${roomCode}`);
        joinGameByCode(roomCode);
    }
    
    async function joinGame() {
        if (!currentUser || boardSelector.value === '') {
            alert("Please select a board first.");
            return;
        }
        const roomCode = document.getElementById('joinCode').value.trim().toUpperCase();
        if (!roomCode) {
            alert('Please enter a game code.');
            return;
        }
        
        const gameRef = ref(database, `games/${roomCode}`);
        const snapshot = await get(gameRef);

        if (!snapshot.exists()) {
            alert("Game not found!");
            return;
        }

        const gameData = snapshot.val();
        if (gameData.status !== 'waiting') {
            alert("This game is already in progress or has finished.");
            return;
        }

        if (gameData.playerWhite === currentUser.uid) {
            alert("You cannot join your own game.");
            return;
        }
        
        const selectedBoardId = boardSelector.value;
        const updates = {
            status: "active",
            playerBlack: currentUser.uid,
            boardBlack: selectedBoardId
        };

        await update(gameRef, updates);
        await set(ref(database, `boards/${selectedBoardId}/currentGame`), roomCode); // Assign game to board

        console.log(`Joined game: ${roomCode}`);
        joinGameByCode(roomCode);
    }
    
    function joinGameByCode(roomCode) {
        // Detach old listener if switching games
        if (gameListener) {
            off(ref(database, `games/${currentGameCode}`), 'value', gameListener);
        }
        
        currentGameCode = roomCode;
        const gameRef = ref(database, `games/${currentGameCode}`);

        // Listen for all changes in the game state
        gameListener = onValue(gameRef, (snapshot) => {
            if (!snapshot.exists()) {
                gameInfo.textContent = "Game not found or has been deleted.";
                return;
            }
            const gameData = snapshot.val();
            updateUIWithGameState(gameData);
        });
    }

    async function makeMove() {
      if (!currentGameCode || !currentUser) return;
      
      const moveText = moveInput.value.trim().toLowerCase();
      if (moveText.length !== 4) {
          alert("Invalid move format. Please use UCI format (e.g., e2e4).");
          return;
      }
      
      const from = moveText.substring(0, 2);
      const to = moveText.substring(2, 4);

      // In a real app, you would validate the move against the FEN using a chess library.
      // For now, we just send it.
      
      const moveData = { from, to, timestamp: new Date().toISOString() };
      const moveRef = ref(database, `games/${currentGameCode}/lastMove`);
      
      await set(moveRef, moveData);
      moveInput.value = '';
    }

    // --- UI Update Function ---
    function updateUIWithGameState(game) {
        let infoText = `Game Code: <strong>${currentGameCode}</strong> | Status: ${game.status}`;
        
        // Determine whose turn it is from the FEN string
        const turn = game.fen.split(' ')[1]; // 'w' for white, 'b' for black
        if (game.status === 'active') {
            infoText += (turn === 'w') ? " | White's Turn" : " | Black's Turn";
        }
        gameInfo.innerHTML = infoText;

        // Update move history
        if (game.moves) {
            // This is a simplified move list. A real app would format PGN.
            moveHistory.textContent = Object.values(game.moves).join('\n');
            moveHistory.scrollTop = moveHistory.scrollHeight;
        } else {
            moveHistory.textContent = 'No moves yet.';
        }
    }
  </script>

</body>
</html>